version: '3'

output: prefixed
silent: true

dotenv: ['.env', '{{.ENV}}/.env', '{{.HOME}}/.env']

vars:
  OS: '{{any .TERMUX_VERSION | ternary "android" OS}}'
  FILE_PREFIX: '{{.TASK_DIR}}/.task.'

tasks:
  bench:
    deps: [bench:r2n]

  bench:r2n:
    deps: [build]
    interactive: true
    cmds:
      - |
        # go test ./cmd/r2n -run=^$ -bench=. -benchmem -cpuprofile=cpu.prof -memprofile=mem.prof |
        go test ./cmd/r2n -run=^$ -bench=. -benchmem |
          rg 'Benchmark|allocs/op' |
          rg '\[prefix\].*' -r '' --passthru |
          rg '\n(\s*[0-9].*)' -r '$1' -U --passthru |
          sort

  test:
    deps: [test:r2n]

  test:r2n:
    deps: [build]
    vars:
      R2N: bin/r2n-{{.OS}}-{{ARCH}}
      CMD: bash -c "echo -e '\r1\r2\n3\n4\r5\r\n6\n\r7\r\r8\n\n9\n'"
      # CMD: bash -c "echo -e '1\r2\r3' | pv -L 2 1>&2"
    cmds:
      - defer: rm -f 1.txt
      - '{{.CMD}}'
      - '{{.R2N}} -prefix="[prefix] " {{.CMD}}'
      - '{{.R2N}} -stdio=stdout -- {{.CMD}}'
      - '{{.R2N}} -stdio=stderr -- {{.CMD}}'
      - '{{.R2N}} -stdio=all -- {{.CMD}}'
      - '{{.R2N}} -- {{.CMD}}'
      - '{{.R2N}} {{.CMD}}'
      # long-line test: len(out) > maxLineLength 이면 강제로 \n 넣어서 라인 write + flush
      - go test -v ./cmd/r2n > 1.txt; rg '\[prefix\] ' 1.txt | wc -l

  release:
    deps: [release:r2n]

  release:r2n:
    sources: ['{{.TASK_DIR}}/.env']
    method: timestamp
    cmds:
      - defer: rm -f "{{.FILE_PREFIX}}{{.TASK}}"
      - task: github:release
        vars: {TASK: {ref: .TASK}, REPO: dgdsingen/go, TAG_NAME: '{{.R2N_VERSION}}', NAME: 'r2n {{.R2N_VERSION}}'}
      - task: github:release:asset
        vars: {TASK: {ref: .TASK}, REPO: dgdsingen/go, FILE: r2n-.*}

  github:release:
    cmds:
      - >-
        curl -sL -X POST
        "https://api.github.com/repos/{{.REPO}}/releases"
        -H "Authorization: Bearer {{.GH_API_TOKEN}}"
        -H "X-GitHub-Api-Version: {{.GH_API_VERSION}}"
        -H "Accept: application/vnd.github+json"
        -d '{
          "tag_name": "{{.TAG_NAME}}",
          "name": "{{.NAME | default .TAG_NAME}}",
          "target_commitish": "{{.TARGET_COMMITISH | default "main"}}",
          "body": "{{.BODY | default ""}}",
          "draft": {{.DRAFT | default false}},
          "prerelease": {{.PRERELEASE | default false}},
          "generate_release_notes": {{.GENERATE_RELEASE_NOTES | default false}},
          "make_latest": "{{.MAKE_LATEST | default true}}"
        }'
        -o "{{.FILE_PREFIX}}{{.TASK}}"

  github:release:asset:
    vars:
      FILES: {sh: 'fd -t=f -d=1 "{{.FILE}}" "{{.TASK_DIR}}/bin/"'}
      RELEASE_ID: {sh: 'jq ".id" "{{.FILE_PREFIX}}{{.TASK}}"'}
    cmds:
      - for: {var: FILES}
        cmd: >-
          {{$name := regexReplaceAll ".*/" .ITEM ""}}
          curl -sL -X POST
          "https://uploads.github.com/repos/{{.REPO}}/releases/{{.RELEASE_ID}}/assets?name={{$name}}"
          -H "Authorization: Bearer {{.GH_API_TOKEN}}"
          -H "X-GitHub-Api-Version: {{.GH_API_VERSION}}"
          -H "Accept: application/vnd.github+json"
          -H "Content-Type: application/octet-stream"
          --data-binary "@{{.ITEM}}"

  build:
    deps:
      # - build:cross:r2n
      - build:r2n
      - {task: build:gui, vars: {CGO_ENABLED: 1}}
        # gui에 포함된 github.com/go-vgo/robotgo 라이브러리는 CGO + dynamic linking 필요. static 빌드시 에러남.
      - build:cidr
      - build:concurrent

  build:cross:*:
    ignore_error: true
    vars:
      APP_NAME: '{{.APP_NAME | default (index .MATCH 0)}}'
    cmds:
      - task: 'build:{{.APP_NAME}}'
        vars:
          GOOS: '{{.ITEM.GOOS}}'
          GOARCH: '{{.ITEM.GOARCH}}'
          APP_NAME: {ref: .APP_NAME}
          OUTPUT: '{{printf "%s/bin/%s-%s-%s" .TASK_DIR .APP_NAME .ITEM.GOOS .ITEM.GOARCH}}'
        for:
          matrix:
            GOOS: ['darwin', 'linux', 'android']
            GOARCH: ['arm64', 'amd64']

  build:*:
    prefix: 'build:{{.APP_NAME}}'
    ignore_error: true
    vars:
      GOOS: '{{.GOOS | default .OS}}'
      GOARCH: '{{.GOARCH | default ARCH}}'
      APP_NAME: '{{.APP_NAME | default (index .MATCH 0)}}'
      APP_VERSION:
        sh: |-
          {{if .APP_VERSION | any}}
            echo -n "{{.APP_VERSION}}"
          {{else}}
            rg '{{.APP_NAME | upper}}_VERSION=(.*)' -r '$1' -o '{{.TASK_DIR}}/.env' || echo 'undefined'
          {{end}}
      PACKAGE: '{{.PACKAGE | default (printf "./cmd/%s" .APP_NAME)}}'
      CGO_ENABLED: '{{.CGO_ENABLED | default "0"}}'
      BUILD_FLAGS: |-
        {{if .BUILD_FLAGS | any}}
          {{.BUILD_FLAGS}}
        {{else}}
          {{if .CGO_ENABLED | toString | eq "1"}}
            -tags netgo -ldflags "-s -w -X main.version={{.APP_VERSION}}"
          {{else}}
            -tags netgo -ldflags "-s -w -X main.version={{.APP_VERSION}} -extldflags '-static'"
          {{end}}
        {{end}}
      OUTPUT: '{{.OUTPUT | default (printf "%s/go/bin/%s" .HOME .APP_NAME)}}'
    sources: ['{{.TASK_DIR}}/cmd/{{.APP_NAME}}/*.go', '{{.TASK_DIR}}/.env']
    generates: ['{{.OUTPUT}}']
    method: timestamp
    cmds:
      - >-
        {{/* android/amd64는 CGO_ENABLED=1을 요구함. 쓸일도 없는데 번거로우니 skip */}}
        {{if and (.GOOS | eq "android") (.GOARCH | eq "amd64")}}
          exit
        {{end}}

        {{/* gui는 darwin에서만 빌드 */}}
        {{if and (.APP_NAME | eq "gui") (.GOOS | ne "darwin")}}
          exit
        {{end}}

        echo 'go build APP_NAME={{.APP_NAME}} APP_VERSION={{.APP_VERSION}} GOOS={{.GOOS}} GOARCH={{.GOARCH}} PACKAGE={{.PACKAGE}} OUTPUT={{.OUTPUT}}'

        CGO_ENABLED='{{.CGO_ENABLED}}'
        GOOS='{{.GOOS}}'
        GOARCH='{{.GOARCH}}'
        go build -o {{.OUTPUT}} {{.BUILD_FLAGS | trim}} {{.PACKAGE}}
